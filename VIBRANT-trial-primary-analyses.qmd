---
title: "VIBRANT Trial - Primary Analyses"
author: Laura Symul (UCLouvain), Laura Vermeren (UCLouvain), Susan Holmes (Stanford University)
date: "`r format(Sys.Date(), '%d %B %Y')`"
format: 
   html:
     page-layout: full
     code-fold: true
     toc: true
     toc-location: left
     toc-depth: 5
     embed-resources: true
execute:
  cache: true # true refresh false
  warning: false
knitr:
  opts_chunk:
    out.width: "100%"
editor: source
---

```{r libraries}
#| warning: false
#| cache: false

library(tidyverse)
library(magrittr)
library(gt)
library(patchwork)
library(SummarizedExperiment)
library(tidySummarizedExperiment)
library(brms)
library(gtsummary)
library(labelled)
library(scales)
# library(gridExtra)
library(ggpubr)
# library(mia) # BiocManager::install("mia")

theme_set(theme_light())
tmp <- fs::dir_map("R", source)
rm(tmp)

```

```{r source-utils}
#| warning: false
#| cache: false
tmp <- fs::dir_map("../VIBRANT-99-utils/R/", source)
rm(tmp)
```


This document details the analyses and provides results for the primary analyses of the VIBRANT trial. 




## Trial data

The data used for these analyses are stored in an `R Bioconductor MultiAssayExperiment` object which contains the QCed and pre-processed data. The code and description of how raw data have been processed and QCed is available on the [`VIBRANT-0-QC-and-preprocessing` GitHub repository](https://github.com/lasy/VIBRANT-0-QC-and-preprocessing) (Still private at the moment, but will be made public upon publication, and anyone wishing to have access can email [Laura Symul](mailto:laura.symul@uclouvain.be)). 


```{r loading-mae}
#| eval: true

mae_file <- 
  fs::dir_ls(str_c(data_dir(), "04 unblinded MAEs/"), regexp = "mae_full_.*\\.rds$") |> 
  sort(decreasing = TRUE) |>
  magrittr::extract(1)

cat(str_c("Loading the RDS file containing the unblinded VIBRANT MAE: /", mae_file |> str_remove(data_dir()), "\n"))

mae <- readRDS(mae_file)

rm(mae_file)

```


## Demographics (Table 1 & suppl. tables by sites)

```{r 01-dem, child = '01-Demographics.qmd'}
#| eval: true
```

## Primary outcomes (Table 2)

```{r 02-primary, child = '02-primary-outcome.qmd'}
#| eval: true
```


## Secondary outcomes (Figures 2-4)

```{r 03-secondary, child = '03-secondary-outcomes.qmd'}
#| eval: true
```



## Supplementary analyses

> TODO

### Applicator staining


#### Numbers

- Proportion of participants that returned applicators
- Proportion of participants with returned applicators for which the staining analysis was done

#### Staining analysis 

##### mITT 

Concordance between self-reports and applicator staining:

- scatter plot of # of self-reported doses vs # of positive staining

- Number of participants that self-reported using at least one dose (= XX)
- Number of participants that had at least one positive staining (= YY)

+ contingency table of self-reported doses and positive staining

- Proportion of participants self-reported using at least one dose **and** have at least one positive staining  (= ZZ/XX)



##### PP

Same but with at least 6 doses


### Time since last dose in 7-days active arms (LC-106-7, LC-115)

We compute this time based on self-reported time of last study product use (daily - CRF plate 32/33) 
-> date/time of last study product = use the crf 32/33 `visit_day` + answer to when? (early morning, etc.)
-> swab time = use `study_day` of the weekly visit.


### LBP colonization in participants with BV post-MTZ

see "After oral metronidazole treatment, 22/70 (30%) people still had a Nugent score of 7 or higher, indicating a failure to resolve BV. Among the 16 of these people exposed to LBP, ZZ had a detectable LBP strain identified after treatment by metagenomics, and TT by qPCR during treatment." 





